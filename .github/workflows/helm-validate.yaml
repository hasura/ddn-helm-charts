name: Helm Validate

on:
  pull_request:
    paths:
      - "charts/**"

jobs:
  detect-changed-charts:
    runs-on: ubuntu-latest
    outputs:
      charts: ${{ steps.extract.outputs.chart_names }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Get changed Chart.yaml files
        id: changed
        uses: tj-actions/changed-files@v42
        with:
          files: charts/*/Chart.yaml

      - name: Extract chart names
        id: extract
        run: |
          echo "Changed files: ${{ steps.changed.outputs.all_changed_files }}"
          # Read changed files into an array
          mapfile -t changed_files <<< "${{ steps.changed.outputs.all_changed_files }}"
          chart_names=()
          for file in "${changed_files[@]}"; do
            chart_dir=$(dirname "$file")
            chart_name=$(basename "$chart_dir")
            chart_names+=("$chart_name")
          done
          # Deduplicate and sort
          unique_sorted_chart_names=$(printf '%s\n' "${chart_names[@]}" | sort -u)
          # Convert to JSON array
          json_array=$(printf '%s\n' "${unique_sorted_chart_names[@]}" | jq -R . | jq -s .)
          # Compress to one line for GitHub Actions output
          json_array_one_line=$(echo "$json_array" | jq -c .)
          echo "chart_names=$json_array_one_line" >> "$GITHUB_OUTPUT"
        outputs:
          chart_names: ${{ steps.extract.outputs.chart_names }}

  validate-helm-charts:
    needs: detect-changed-charts
    runs-on: ubuntu-latest
    strategy:
      matrix:
        chart: ${{ fromJson(needs.detect-changed-charts.outputs.charts) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4.0.0

      - name: Lint Helm Chart
        run: helm lint charts/${{ matrix.chart }}

      - name: Run Helm Template
        shell: bash
        run: |
          chart="${{ matrix.chart }}"
          echo "Running helm template for chart: $chart"

          case "$chart" in
            ndc-bigquery)
              helm template connector charts/ndc-bigquery \
                --values tests/ndc-bigquery-values.yaml \
                --namespace connector-ns
              ;;
            ndc-bigquery-git-sync)
              helm template gateway charts/ndc-bigquery-git-sync \
                --values tests/ndc-bigquery-git-sync-values.yaml \
                --namespace connector-ns
              ;;
            *)
              # Default template run for other charts
              helm template "$chart" charts/"$chart"
              ;;
          esac
