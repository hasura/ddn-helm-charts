global:
  domain: ""
  subDomain: true
  containerRegistry: "gcr.io/hasura-ee"
  certIssuer: "letsencrypt-prod"
  uriScheme: "https"
  persistence:
    enabled: true
  serviceCatalog:
    - name: data
      port: 8080
    - name: ddn-cps-engine
      port: 3000
  serviceAccount:
    enabled: true
  routes:
    enabled: false

additionalLabels:
  group: ddn-workspace

networkPolicy:
  ingress:
    enabled: true
  egress:
    enabled: true
    allowedApps:
      - data
      - ddn-cps-engine

useReleaseName: true

# Container Configs
image:
  repository: "ddn-native-workspace"
  tag: ""
replicas: "1"
httpPort: 8123
setControlPlaneUrls: true
persistence:
  enabled: true
  size: 10Gi
healthChecks:
  enabled: true
  livenessProbe: |
    httpGet:
      path: /healthz
      port: 8123
  readinessProbe: |
    httpGet:
      path: /healthz
      port: 8123
securityContext:
  runAsUser: 10001
  fsGroup: 10001
  runAsNonRoot: true

resources: |
  requests:
    cpu: 500m
    memory: 2048Mi
  limits:
    memory: 2048Mi

hostAliases:
  - ip: "127.0.0.1"
    hostnames:
      - "local.hasura.dev"

dataHost: "http://data:8080"
ddnCpsEngineHost: "http://ddn-cps-engine:3000"
consoleUrl: ""
ddnPromptqlEndpoint: ""
skipTlsVerify: false
noAuth:
  enabled: true
secrets:
  password: ""

# Additional Container Envs
env: |
  - name: CODE_SERVER_PORT
    value: "8123"
  {{- if not .Values.noAuth.enabled }}
  - name: HASHED_PASSWORD
    valueFrom:
      secretKeyRef:
        name: {{ include "common.secretsName" $ }}
        key: WORKSPACE_PASSWORD
  {{- else }}
  - name: CODE_SERVER_NO_AUTH
    value: "true"
  {{- end }}

  {{- if include "ddn-workspace.authProxy.enabled" . }}
  {{- end }}
  - name: HASURA_DDN_INSECURE_SKIP_TLS_VERIFY
    value: {{ .Values.skipTlsVerify | quote }}
  {{- if .Values.setControlPlaneUrls }}
  - name: HASURA_DDN_CONSOLE_HOST
    value: {{ required "DDN Console URL (.Values.consoleUrl) is required" .Values.consoleUrl | quote }}
  - name: HASURA_DDN_CONTROL_PLANE_HOST
    value: {{ required "Data URL is required" .Values.dataHost | quote }}
  - name: HASURA_DDN_CONNECTOR_HUB_REGISTRY_HOST
    value: {{ required "DDN CPS Engine URL is required" .Values.ddnCpsEngineHost | quote }}
  {{- if .Values.ddnPromptqlEndpoint }}
  - name: HASURA_DDN_PROMPTQL_ENDPOINT
    value: {{ .Values.ddnPromptqlEndpoint | quote }}
  - name: HASURA_DDN_PROMPTQL_CONSOLE_HOST
    value: {{ required "DDN Console URL (.Values.consoleUrl) is required" .Values.consoleUrl | quote }}
  {{- end }}

  {{- if include "ddn-workspace.authProxy.enabled" . }}
  {{- end }}
  {{- end }}

  {{- if include "ddn-workspace.authProxy.enabled" . }}
  {{- end }}


extraVolumes: |
  - name: ddn-workspace-data
  {{- if and (.Values.persistence).enabled (.Values.global.persistence).enabled }}
    persistentVolumeClaim:
      claimName: {{ include "common.name" . }}-data
  {{- else }}
    emptyDir: {}
  {{- end }}

  {{- if include "ddn-workspace.authProxy.enabled" . }}
  {{- end }}

extraVolumeMounts: |
  - name: ddn-workspace-data
    mountPath: "/workspace"

# Ingress Configs
# enable ingress / routes only if there is no internal network connectivity
# between control plane and data planes
ingress:
  enabled: true
  ingressClassName: nginx
  hostName: '{{ template "ddn-workspace.domain" . }}'
  additionalAnnotations: '{{ template "ddn-workspace.ingress.annotations" . }}'
  path: '{{ template "ddn-workspace.path" . }}'

routes:
  enabled: false

# Auth Proxy Configuration (only enabled when noAuth.enabled is true)
authProxy:
  enabled: false  # Will be automatically set based on noAuth.enabled
  
  # Image Configuration
  image:
    repository: "auth-proxy"
    tag: "latest"
    pullPolicy: IfNotPresent
  
  # Routing Configuration
  routing:
    # Mode will be set automatically based on global.subDomain
    # "subdomain" for <workspace>.domain or "path" for domain/<workspace>/
    containerNamePattern: "{{ include \"common.name\" . }}"  # Use the workspace name
  
  # JWT Configuration
  jwt:
    issuer: "https://auth.hasura.io/ddn/token"
    audience: "workspaces"
    jwksUri: ""  # Must be provided when authProxy is enabled
  
  # Cookie Configuration
  cookie:
    name: "auth-session"
    httpOnly: true
    sameSite: "Lax"
    maxAge: 3600
    # domain, path, and secure will be configured automatically
  
  # Workspace Configuration
  workspace:
    servicePort: 8123  # Port of the ddn-workspace service
    claimKey: "workspaces"
  
  # Service Configuration
  service:
    type: ClusterIP
    port: 8080
    adminPort: 9901
  
  # Resource Configuration
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi
  
  # Replicas
  replicas: 1

# Extra containers (auth-proxy sidecar when enabled)
extraContainers: |
  {{- if include "ddn-workspace.authProxy.enabled" . }}
  - name: auth-proxy
    image: "{{ .Values.global.containerRegistry }}/{{ .Values.authProxy.image.repository }}:{{ .Values.authProxy.image.tag }}"
    imagePullPolicy: {{ .Values.authProxy.image.pullPolicy }}
    ports:
      - name: auth-http
        containerPort: {{ .Values.authProxy.service.port }}
        protocol: TCP
      - name: auth-admin
        containerPort: {{ .Values.authProxy.service.adminPort }}
        protocol: TCP
    livenessProbe:
      httpGet:
        path: /ready
        port: {{ .Values.authProxy.service.adminPort }}
      initialDelaySeconds: 30
      periodSeconds: 10
    readinessProbe:
      httpGet:
        path: /ready
        port: {{ .Values.authProxy.service.adminPort }}
      initialDelaySeconds: 5
      periodSeconds: 5
    resources:
      {{- toYaml .Values.authProxy.resources | nindent 6 }}
    volumeMounts:
    env:
      # JWT Configuration
      - name: JWT_ISSUER
        value: "{{ .Values.authProxy.jwt.issuer }}"
      - name: JWT_AUDIENCE
        value: "{{ .Values.authProxy.jwt.audience }}"
      - name: JWKS_URI
        value: "{{ .Values.authProxy.jwt.jwksUri }}"
      
      # Cookie Configuration
      - name: COOKIE_NAME
        value: "{{ .Values.authProxy.cookie.name }}"
      - name: COOKIE_DOMAIN
        value: "{{ include "ddn-workspace.authProxy.cookieDomain" . }}"
      - name: COOKIE_PATH
        value: "{{ include "ddn-workspace.authProxy.cookiePath" . }}"
      - name: COOKIE_SECURE
        value: "{{ include "ddn-workspace.authProxy.cookieSecure" . }}"
      - name: COOKIE_HTTP_ONLY
        value: "{{ .Values.authProxy.cookie.httpOnly }}"
      - name: COOKIE_SAME_SITE
        value: "{{ .Values.authProxy.cookie.sameSite }}"
      - name: COOKIE_MAX_AGE
        value: "{{ .Values.authProxy.cookie.maxAge | toString }}"
      
      # Routing Configuration
      - name: ROUTING_MODE
        value: "{{ include "ddn-workspace.authProxy.routingMode" . }}"
      - name: BASE_DOMAIN
        value: "{{ .Values.global.domain }}"
      - name: CONTAINER_NAME_PATTERN
        value: "{{ include "common.name" . }}"
      
      # Workspace Configuration (localhost since same pod)
      - name: WORKSPACE_SERVICE_HOST
        value: "127.0.0.1"
      - name: WORKSPACE_SERVICE_PORT
        value: "{{ .Values.authProxy.workspace.servicePort | toString }}"
      - name: WORKSPACE_CLAIM_KEY
        value: "{{ .Values.authProxy.workspace.claimKey }}"
      
      # Envoy Configuration
      - name: ENVOY_PORT
        value: "{{ .Values.authProxy.service.port | toString }}"
      - name: ENVOY_ADMIN_PORT
        value: "{{ .Values.authProxy.service.adminPort | toString }}"
  {{- end }}

  {{- if include "ddn-workspace.authProxy.enabled" . }}
  {{- end }}

# Additional service ports for auth-proxy
containerPorts: |
  {{- if include "ddn-workspace.authProxy.enabled" . }}
  - name: auth-http
    containerPort: {{ .Values.authProxy.service.port }}
    protocol: TCP
  - name: auth-admin
    containerPort: {{ .Values.authProxy.service.adminPort }}
    protocol: TCP
  {{- end }}

# Service ports configuration
servicePorts: |
  {{- if include "ddn-workspace.authProxy.enabled" . }}
  - port: {{ .Values.authProxy.service.port }}
    targetPort: auth-http
    protocol: TCP
    name: auth-http
  - port: {{ .Values.authProxy.service.adminPort }}
    targetPort: auth-admin
    protocol: TCP
    name: auth-admin
  {{- end }}
