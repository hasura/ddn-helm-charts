{{- if include "ddn-workspace.authProxy.enabled" . }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "ddn-workspace.authProxy.name" . }}-config
  labels:
    {{- include "common.labels" . | nindent 4 }}
    component: auth-proxy
data:
  envoy.yaml: |
    admin:
      address:
        socket_address:
          protocol: TCP
          address: 0.0.0.0
          port_value: {{ .Values.authProxy.service.adminPort }}
    static_resources:
      listeners:
      - name: listener_0
        address:
          socket_address:
            address: 0.0.0.0
            port_value: {{ .Values.authProxy.service.port }}
        filter_chains:
        - filters:
          - name: envoy.filters.network.http_connection_manager
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
              stat_prefix: ingress_http
              upgrade_configs:
                - upgrade_type: websocket
              codec_type: AUTO
              # Enable access logging to see request routing
              access_log:
              - name: envoy.access_loggers.stdout
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog
                  log_format:
                    text_format: |
                      [%START_TIME%] "%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%"
                      %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT%
                      %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% "%REQ(X-FORWARDED-FOR)%"
                      "%REQ(USER-AGENT)%" "%REQ(X-REQUEST-ID)%" "%REQ(:AUTHORITY)%" "%UPSTREAM_HOST%"
                      upstream_cluster="%UPSTREAM_CLUSTER%" upstream_local_address="%UPSTREAM_LOCAL_ADDRESS%"
              route_config:
                name: local_route
                max_direct_response_body_size_bytes: 3672040
                virtual_hosts:
                - name: local_service
                  domains: ["*"]
                  routes:
                  # Authentication endpoint - handled by Lua filter
                  - match:
                      path: "/auth"
                    route:
                      cluster: workspace_service
                      timeout: 30s
                    response_headers_to_add:
                      - header:
                          key: "Strict-Transport-Security"
                          value: "max-age=31536000; includeSubDomains"
                      - header:
                          key: "X-Frame-Options"
                          value: "SAMEORIGIN"
                      - header:
                          key: "Referrer-Policy"
                          value: "strict-origin"
                      - header:
                          key: "X-Content-Type-Options"
                          value: "nosniff"
                      - header:
                          key: "X-Xss-Protection"
                          value: "1; mode=block"
                      - header:
                          key: "Content-Security-Policy"
                          value: "default-src 'self'; img-src 'self' data:; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';"
                  
                  # UI HTML - serve main page
                  - match:
                      path: "/ui"
                    direct_response:
                      status: 200
                      body:
                        filename: "/var/www/html/index.html"
                    response_headers_to_add:
                    - header:
                        key: "Content-Type"
                        value: "text/html; charset=utf-8"
                    - header:
                        key: "Strict-Transport-Security"
                        value: "max-age=31536000; includeSubDomains"
                    - header:
                        key: "X-Frame-Options"
                        value: "SAMEORIGIN"
                    - header:
                        key: "Referrer-Policy"
                        value: "strict-origin"
                    - header:
                        key: "X-Content-Type-Options"
                        value: "nosniff"
                    - header:
                        key: "X-Xss-Protection"
                        value: "1; mode=block"
                    - header:
                        key: "Content-Security-Policy"
                        value: "default-src 'self'; img-src 'self' data:; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';"
                  
                  # UI Static Assets - serve CSS and JS files
                  - match:
                      path: "/ui/client.js"
                    direct_response:
                      status: 200
                      body:
                        filename: "/var/www/html/client.js"
                    response_headers_to_add:
                    - header:
                        key: "Content-Type"
                        value: "application/javascript"
                    - header:
                        key: "Strict-Transport-Security"
                        value: "max-age=31536000; includeSubDomains"
                    - header:
                        key: "X-Frame-Options"
                        value: "SAMEORIGIN"
                    - header:
                        key: "Referrer-Policy"
                        value: "strict-origin"
                    - header:
                        key: "X-Content-Type-Options"
                        value: "nosniff"
                    - header:
                        key: "X-Xss-Protection"
                        value: "1; mode=block"
                    - header:
                        key: "Content-Security-Policy"
                        value: "default-src 'self'; img-src 'self' data:; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';"
                  
                  - match:
                      path: "/ui/client.css"
                    direct_response:
                      status: 200
                      body:
                        filename: "/var/www/html/client.css"
                    response_headers_to_add:
                    - header:
                        key: "Content-Type"
                        value: "text/css"
                    - header:
                        key: "Strict-Transport-Security"
                        value: "max-age=31536000; includeSubDomains"
                    - header:
                        key: "X-Frame-Options"
                        value: "SAMEORIGIN"
                    - header:
                        key: "Referrer-Policy"
                        value: "strict-origin"
                    - header:
                        key: "X-Content-Type-Options"
                        value: "nosniff"
                    - header:
                        key: "X-Xss-Protection"
                        value: "1; mode=block"
                    - header:
                        key: "Content-Security-Policy"
                        value: "default-src 'self'; img-src 'self' data:; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';"
                  
                  - match:
                      path: "/ui/output.css"
                    direct_response:
                      status: 200
                      body:
                        filename: "/var/www/html/output.css"
                    response_headers_to_add:
                    - header:
                        key: "Content-Type"
                        value: "text/css"
                    - header:
                        key: "Strict-Transport-Security"
                        value: "max-age=31536000; includeSubDomains"
                    - header:
                        key: "X-Frame-Options"
                        value: "SAMEORIGIN"
                    - header:
                        key: "Referrer-Policy"
                        value: "strict-origin"
                    - header:
                        key: "X-Content-Type-Options"
                        value: "nosniff"
                    - header:
                        key: "X-Xss-Protection"
                        value: "1; mode=block"
                    - header:
                        key: "Content-Security-Policy"
                        value: "default-src 'self'; img-src 'self' data:; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';"
                  
                  # Default workspace routes
                  - match:
                      prefix: "/"
                    route:
                      cluster: workspace_service
                      timeout: 30s

              http_filters:
              # Lua filter for authentication
              - name: envoy.filters.http.lua
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua
                  inline_code: |
                    -- JSON encode/decode functions
                    package.path = package.path .. ";/usr/local/share/lua/5.1/?.lua"
                    package.cpath = package.cpath .. ";/usr/local/lib/lua/5.1/?.so"

                    local cjson = require "cjson"

                    -- JSON decode function (simplified)
                    local function json_decode(str)
                      local function decode_value(s, pos)
                        local first = s:sub(pos, pos)
                        if first == '"' then
                          local i = pos + 1
                          while i <= #s do
                            if s:sub(i, i) == '"' and s:sub(i-1, i-1) ~= '\\' then
                              return s:sub(pos + 1, i - 1), i + 1
                            end
                            i = i + 1
                          end
                        elseif first == '{' then
                          local obj = {}
                          local i = pos + 1
                          while i <= #s and s:sub(i, i) ~= '}' do
                            if s:sub(i, i) == '"' then
                              local key, next_pos = decode_value(s, i)
                              i = next_pos
                              while i <= #s and (s:sub(i, i) == ' ' or s:sub(i, i) == ':') do i = i + 1 end
                              local value, next_pos2 = decode_value(s, i)
                              obj[key] = value
                              i = next_pos2
                              while i <= #s and (s:sub(i, i) == ' ' or s:sub(i, i) == ',') do i = i + 1 end
                            else
                              i = i + 1
                            end
                          end
                          return obj, i + 1
                        end
                        return nil, pos
                      end
                      return decode_value(str, 1)
                    end

                    -- GraphQL workspace access check function
                    local function check_workspace_access(request_handle, token, auth_method, workspace_name)
                      local data_host = os.getenv("DATA_HOST") or "api.hasura.io"

                      local query_body = '{"query":"query fetchWorkspace($where: ddn_workspace_bool_exp!) { ddn_workspace(where: $where) { id password name } }","variables":{"where":{"name":{"_eq":"' .. workspace_name .. '"}}},"operationName":"fetchWorkspace"}'

                      local auth_header = auth_method .. " " .. token

                      local headers, body = request_handle:httpCall(
                        "graphql_cluster",
                        {
                          [":method"] = "POST",
                          [":path"] = "/v1/graphql",
                          [":authority"] = data_host,
                          ["content-type"] = "application/json",
                          ["authorization"] = auth_header
                        },
                        query_body,
                        5000
                      )
                      request_handle:logInfo("LUA SCRIPT: check_workspace_access: data_host: " .. data_host)
                      request_handle:logInfo("LUA SCRIPT: check_workspace_access: headers: " .. cjson.encode(headers) .. ", body: " .. (body or "nil"))
                      
                      if not body then
                        return false, "GraphQL request failed"
                      end
                      
                      local response = cjson.decode(body)
                      request_handle:logInfo("LUA SCRIPT: check_workspace_access: headers: " .. cjson.encode(headers) .. ", body: " .. (body or "nil"))
                      request_handle:logInfo("LUA SCRIPT: check_workspace_access: response: " .. cjson.encode(response))
                      if response and response.data and response.data.ddn_workspace then
                        for i = 1, #response.data.ddn_workspace do
                          request_handle:logInfo("LUA SCRIPT: check_workspace_access: workspace: " .. cjson.encode(response.data.ddn_workspace[i]))
                          request_handle:logInfo("LUA SCRIPT: check_workspace_access: workspace_name: " .. workspace_name)
                          if response.data.ddn_workspace[i].name == workspace_name then
                            return true, nil
                          end
                        end
                      end
                      
                      if response and response.errors then
                        local error_msg = "GraphQL error"
                        if response.errors[1] and response.errors[1].message then
                          error_msg = response.errors[1].message
                        end
                        return false, error_msg
                      end
                      
                      return false, "No workspace access found"
                    end

                    function envoy_on_request(request_handle)
                      local path = request_handle:headers():get(":path")
                      local method = request_handle:headers():get(":method")
                      
                      if path == "/auth" and method == "POST" then
                        local body = request_handle:body()
                        if not body then
                          request_handle:respond(
                            {[":status"] = "400", ["content-type"] = "application/json"},
                            '{"status":"error","message":"Missing request body"}'
                          )
                          return
                        end

                        local body_length = body:length()
                        if body_length == 0 then
                          request_handle:respond(
                            {[":status"] = "400", ["content-type"] = "application/json"},
                            '{"status":"error","message":"Empty request body"}'
                          )
                          return
                        end

                        local body_string = body:getBytes(0, body_length)
                        local request_data = cjson.decode(body_string)
                        if not request_data or not request_data.token or not request_data.auth_method then
                          request_handle:respond(
                            {[":status"] = "400", ["content-type"] = "application/json"},
                            '{"status":"error","message":"Missing token or auth_method"}'
                          )
                          return
                        end

                        -- Extract workspace name from Host header (subdomain approach)
                        local host_header = request_handle:headers():get(":authority") or request_handle:headers():get("host")
                        local workspace_name = "default-workspace"
                        if host_header then
                          -- Extract workspace name from subdomain (e.g., karthikvt26-workspace from karthikvt26-workspace-ddn-workspace.lux-dev.hasura.me)
                          local subdomain = string.match(host_header, "^([^%.]+)")
                          if subdomain then
                            -- Remove -ddn-workspace suffix if present
                            workspace_name = string.gsub(subdomain, "%-ddn%-workspace$", "")
                          end
                        end
                        local has_access, error_msg = check_workspace_access(
                          request_handle, request_data.token, request_data.auth_method, workspace_name
                        )


                        request_handle:logInfo("LUA SCRIPT: has_access: " .. tostring(has_access) .. ", error_msg: " .. (error_msg or "nil"))

                        if not has_access then
                          request_handle:respond(
                            {[":status"] = "403", ["content-type"] = "application/json"},
                            '{"status":"error","message":"Access denied"}'
                          )
                          return
                        end

                        local cookie_domain = os.getenv("COOKIE_DOMAIN") or ".localhost"
                        local cookie_value = "authenticated=true; Domain=" .. cookie_domain .. "; Path=/; HttpOnly"
                        
                        request_handle:respond(
                          {[":status"] = "200", ["content-type"] = "application/json", ["set-cookie"] = cookie_value},
                          '{"status":"success","message":"Authentication successful"}'
                        )
                        return
                      end

                      -- Allow access to UI paths without authentication
                      if string.match(path, "^/ui") then
                        return
                      end
                      
                      local cookie_header = request_handle:headers():get("cookie")
                      if cookie_header and string.find(cookie_header, "authenticated=true") then
                        return
                      end

                      request_handle:respond({[":status"] = "302", ["location"] = "/ui"}, "")
                    end
              # Router Filter (must be last)
              - name: envoy.filters.http.router
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

      clusters:
      - name: workspace_service
        connect_timeout: 0.25s
        type: LOGICAL_DNS
        lb_policy: ROUND_ROBIN
        load_assignment:
          cluster_name: workspace_service
          endpoints:
          - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: 127.0.0.1
                    port_value: 8123
      
      - name: graphql_cluster
        connect_timeout: 0.25s
        type: LOGICAL_DNS
        lb_policy: ROUND_ROBIN

        load_assignment:
          cluster_name: graphql_cluster
          endpoints:
          - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: {{ .Values.authProxy.dataHost }}
                    port_value: {{ .Values.authProxy.dataPort | default "443" | int }}

{{- end }}
